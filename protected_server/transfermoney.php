<?php
require_once('database.php');
require_once('auth.php');

//post with money you want, and the destination address
//into database to using the user's session id to get the source address
//and transfer that money
if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    if(!empty($_POST["destination_address"]) && !empty($_POST["amount"])) {
        if (empty($_POST["token"]) || $_POST["token"] != $_COOKIE["csrfToken"]){
	    setcookie("csrfToken", $randomToken, time() - 3600, '/');
	    echo "Sorry, we protect against Cross-Site Request Forgeries. Try somewhere else!";
            return;
        }
        if (empty($_SESSION['userlogin'])){
            echo "Sorry, you are not logged in";
            return;
        }
        // TODO get sessionid and user from that id
        if (!$query = $connection->query("SELECT * FROM users WHERE user_login = '".$_SESSION['userlogin']."'")){
            // echo mysqli_error($connection);
            echo $connection->lastErrorMsg();
            echo "There was an error with the database.";
        }
        $user = $query->fetchArray();
        $source = $user['bank_address'];
        $dest = $_POST["destination_address"];

        // could check for valid address
        if (!$query = $connection->query("SELECT balance FROM users WHERE bank_address = '".$dest."'")){
            // echo mysqli_error($connection);
            echo "There was an error with the database.";
        }
        // could check amounts are valid
        $destUser = $query->fetchArray();
        $destBalance = $destUser['balance'] + $_POST["amount"]*100;
        $sourceBalance = $user['balance'] - $_POST["amount"]*100;

        if (!$connection->query("UPDATE users SET balance=".$destBalance." WHERE bank_address='".$dest."'")) {
            // echo mysqli_error($connection);
            echo $connection->lastErrorMsg();
            echo "There was an error with the datbase.";
        }
        if (!$connection->query("UPDATE users SET balance=".$sourceBalance." WHERE bank_address='".$source."'")) {
            // echo mysqli_error($connection);
            echo $connection->lastErrorMsg();
            echo "There was an error with the database.";
        }

        echo money_format('$%i', $_POST["amount"]) . " sent from address " . $source . " to address " . $dest;

    }else{
        echo "Invalid destination address or amount.";
    }
}
else {
	echo "Invalid request";
}
?>
